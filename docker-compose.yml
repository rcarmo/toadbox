---
x-env: &env
  DISPLAY: ":10"
  TERM: xterm-256color
  PUID: "${PUID:-1000}"
  PGID: "${PGID:-1000}"
  TZ: Europe/Lisbon

x-agent: &agent
  image: ghcr.io/rcarmo/agentbox:latest
  environment:
    <<: *env
    WORKSPACE_NAME: default
  restart: unless-stopped
  deploy:
    resources:
      limits:
        cpus: '${CPU_LIMITS:-2}'
        memory: '${MEMORY_LIMITS:-4G}'
  privileged: true  # Required for Docker-in-Docker
  networks:
    - the_matrix
  volumes:
    - local:/home/agent/.local
    - vibe:/home/agent/.vibe
    - ./workspaces/${WORKSPACE_NAME:-default}:/workspace

services:
  syncthing:
    image: syncthing/syncthing:latest
    container_name: agent-syncthing
    hostname: sandbox
    environment:
      <<: *env
      HOME: /var/syncthing/config
      STGUIADDRESS: 0.0.0.0:8384
      GOMAXPROCS: "1"
    volumes:
      - ./workspaces:/workspaces:Z
      - ./config:/var/syncthing/config:Z
    network_mode: host
    restart: unless-stopped
    cpuset: "0"
    cpu_shares: 2
    healthcheck:
      test: curl -fkLsS -m 2 127.0.0.1:8384/rest/noauth/health | grep -o --color=never OK || exit 1
      interval: 1m
      timeout: 10s
      retries: 3

  gotel:
    <<: *agent
    container_name: agent-gotel
    hostname: gotel
    environment:
      <<: *env
      ENABLE_DOCKER: "true"
      WORKSPACE_NAME: gotel
    ports:
      - "3000:3000"  # web service
      - "3020:3020"  # web service

  guerite:
    <<: *agent
    container_name: agent-guerite
    hostname: guerite
    environment:
      <<: *env
      ENABLE_DOCKER: "true"
      WORKSPACE_NAME: guerite

  feed-summarizer:
    <<: *agent
    container_name: agent-feed-summarizer
    hostname: feed-summarizer
    environment:
      <<: *env
      WORKSPACE_NAME: feed-summarizer

  go-html5:
    <<: *agent
    container_name: agent-go-html5
    hostname: go-html5
    ports:
      - "3000:3000"  # web service
    environment:
      <<: *env
      WORKSPACE_NAME: go-html5

  toad:
    <<: *agent
    container_name: agent-toad
    hostname: toad
    ports:
      - "8001:8000"  # web service
    environment:
      <<: *env
      WORKSPACE_NAME: toad

  agentbox:
    <<: *agent
    container_name: agent-agentbox
    hostname: agent
    ports:
      - "8002:8000"  # web service
    environment:
      <<: *env
      WORKSPACE_NAME: agentbox

volumes:
  vibe:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.vibe
  local:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./home/.local

networks:
  the_matrix:
    driver: bridge